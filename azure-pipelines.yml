trigger:
- main

variables:
  project: 'nkavid'
  repository: 'reqt'
  tag: '0.0.2'

pool:
  vmImage: ubuntu-latest

steps:
  - checkout: self
    lfs: false
    submodules: true
    persistCredentials: true

  - task: Cache@2
    displayName: "Docker: Image cache task"
    inputs:
      key: 'docker | "$(Agent.OS)" | "$(tag)" | cache'
      path: $(Pipeline.Workspace)/docker_cache
      cacheHitVar: CACHE_RESTORED

  - script: |
      docker load -i $(Pipeline.Workspace)/docker_cache/cache.tar
    displayName: 'Docker: Load image'
    condition: and(not(canceled()), not(failed()), eq(variables.CACHE_RESTORED, 'true'))

  - script: |
      ./docker.sh image
    displayName: 'Docker: Build image'
    condition: and(not(canceled()), not(failed()), ne(variables.CACHE_RESTORED, 'true'))

  - script: |
      mkdir -p $(Pipeline.Workspace)/docker_cache
      docker save -o $(Pipeline.Workspace)/docker_cache/cache.tar $(project)/$(repository):$(tag)
    displayName: 'Docker: Save image'
    condition: and(not(canceled()), not(failed()), ne(variables.CACHE_RESTORED, 'true'))

  - script: |
      ./docker.sh cpp
    displayName: 'Build: C++ build'
    condition: and(not(canceled()), not(failed()))

  - script: |
      ./docker.sh python
    displayName: 'Build: Python build'
    condition: and(not(canceled()), not(failed()))

  - script: |
      ./docker.sh check
    displayName: 'Check: Run linters and autoformatters'
    condition: and(not(canceled()), not(failed()))
